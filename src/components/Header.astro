---
import { siteConfig } from "../config";
import { Icon } from "astro-icon/components";

const hasProjects = siteConfig.projects && siteConfig.projects.length > 0;
const hasExperience = siteConfig.experience && siteConfig.experience.length > 0;
const hasEducation = siteConfig.education && siteConfig.education.length > 0;
const hasReferences = siteConfig.references && siteConfig.references.length > 0;
---

<!-- Compact Terminal-style Header -->
<header id="terminal-header" class="fixed top-0 left-0 right-0 z-50 terminal-header">
  <!-- Single-row terminal strip -->
  <div class="terminal-strip">
    <!-- Window controls (traffic lights) -->
    <div class="window-controls">
      <span class="window-control close"></span>
      <span class="window-control minimize"></span>
      <span class="window-control maximize"></span>
    </div>

    <!-- Terminal prompt (click to scroll to top) -->
    <button id="terminal-prompt" class="terminal-prompt" aria-label="Scroll to top">
      <span class="prompt-user">yousuf@khan</span>
      <span class="prompt-separator">:</span>
      <span class="prompt-path">~</span>
    </button>

    <!-- Navigation pills -->
    <nav id="terminal-nav" class="terminal-nav">
      <a href="#about" data-nav="about" class="nav-pill">[> about]</a>
      {
        hasProjects && (
          <a href="#projects" data-nav="projects" class="nav-pill">[> projects]</a>
        )
      }
      {
        hasExperience && (
          <a href="#experience" data-nav="experience" class="nav-pill">[> experience]</a>
        )
      }
      {
        hasEducation && (
          <a href="#education" data-nav="education" class="nav-pill">[> education]</a>
        )
      }
      {
        hasReferences && (
          <a href="#references" data-nav="references" class="nav-pill">[> references]</a>
        )
      }
    </nav>

    <!-- Social icons -->
    <div class="social-links">
      {
        siteConfig.social?.email && (
          <a
            href={`mailto:${siteConfig.social.email}`}
            aria-label="Email"
            class="social-link"
          >
            <Icon name="simple-icons:gmail" width="14" height="14" />
          </a>
        )
      }
      {
        siteConfig.social?.linkedin && (
          <a
            href={siteConfig.social.linkedin}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="LinkedIn"
            class="social-link"
          >
            <Icon name="simple-icons:linkedin" width="14" height="14" />
          </a>
        )
      }
      <a
        href="https://medium.com/@rats"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Medium"
        class="social-link"
      >
        <Icon name="simple-icons:medium" width="14" height="14" />
      </a>
      {
        siteConfig.social?.resume && (
          <a
            href={siteConfig.social.resume}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Resume"
            class="social-link"
          >
            <Icon name="simple-icons:readdotcv" width="14" height="14" />
          </a>
        )
      }
      {
        siteConfig.social?.github && (
          <a
            href={siteConfig.social.github}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="GitHub"
            class="social-link"
          >
            <Icon name="simple-icons:github" width="14" height="14" />
          </a>
        )
      }
    </div>

    <!-- Mobile menu toggle -->
    <button id="terminal-menu-toggle" class="menu-toggle" aria-label="Toggle menu">
      <span class="toggle-bracket">[</span>
      <span class="toggle-text">MENU</span>
      <span class="toggle-bracket">]</span>
    </button>
  </div>

  <!-- Mobile dropdown navigation -->
  <nav id="mobile-nav" class="mobile-nav">
    <a href="#about" data-nav="about" class="nav-pill">[> about]</a>
    {
      hasProjects && (
        <a href="#projects" data-nav="projects" class="nav-pill">[> projects]</a>
      )
    }
    {
      hasExperience && (
        <a href="#experience" data-nav="experience" class="nav-pill">[> experience]</a>
      )
    }
    {
      hasEducation && (
        <a href="#education" data-nav="education" class="nav-pill">[> education]</a>
      )
    }
    {
       hasReferences && (
        <a href="#references" data-nav="references" class="nav-pill">[> references]</a>
      )
    }
  </nav>

  <!-- Scroll progress bar -->
  <div id="terminal-progress" class="terminal-progress">
    <div class="progress-cursor"></div>
    <div class="progress-bar"></div>
  </div>
</header>

<style>
  /* Terminal Header Base */
  .terminal-header {
    background: transparent;
    transition: all 0.3s ease;
  }

  /* Single-row terminal strip (~45px height) */
  .terminal-strip {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 20px;
    background: rgba(248, 246, 243, 0.95);
    border-bottom: 1px solid var(--color-warm-border);
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
    height: 45px;
  }

  body.dark .terminal-strip {
    background: rgba(13, 17, 23, 0.95);
    border-bottom-color: var(--color-dark-border);
  }

  /* Window Controls (Traffic Lights) */
  .window-controls {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .window-control {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .window-control.close {
    background: #ff5f57;
    border: 1px solid #e0443e;
  }

  .window-control.minimize {
    background: #febc2e;
    border: 1px solid #d89e24;
  }

  .window-control.maximize {
    background: #28c840;
    border: 1px solid #1aab29;
  }

  .window-control:hover {
    filter: brightness(1.1);
  }

  /* Terminal Prompt (clickable to scroll to top) */
  .terminal-prompt {
    display: flex;
    align-items: center;
    gap: 3px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    color: var(--color-warm-text-primary);
    letter-spacing: -0.3px;
    flex-shrink: 0;
    white-space: nowrap;
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  body.dark .terminal-prompt {
    color: var(--color-dark-text-primary);
  }

  .terminal-prompt:hover {
    opacity: 0.7;
  }

  .prompt-user {
    color: var(--color-deep-teal);
    font-weight: 600;
  }

  body.dark .prompt-user {
    color: var(--color-dark-teal);
  }

  .prompt-separator {
    color: var(--color-warm-text-secondary);
  }

  body.dark .prompt-separator {
    color: var(--color-dark-text-secondary);
  }

  .prompt-path {
    color: var(--color-deep-teal);
    font-weight: 500;
  }

  body.dark .prompt-path {
    color: var(--color-dark-teal);
  }

  /* Navigation Pills (inline) */
  .terminal-nav {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
    justify-content: center;
  }

  .nav-pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    background: transparent;
    border: 1px solid var(--color-warm-border);
    border-radius: 3px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    color: var(--color-warm-text-secondary);
    text-decoration: none;
    white-space: nowrap;
    transition: all 0.2s ease;
    cursor: pointer;
    letter-spacing: -0.2px;
  }

  body.dark .nav-pill {
    border-color: var(--color-dark-border);
    color: var(--color-dark-text-secondary);
  }

  .nav-pill:hover {
    border-color: var(--color-deep-teal);
    background: rgba(15, 76, 92, 0.05);
    transform: translateY(-1px);
  }

  body.dark .nav-pill:hover {
    border-color: var(--color-dark-teal);
    background: rgba(88, 166, 184, 0.1);
  }

  .nav-pill.active {
    border-color: var(--color-deep-teal);
    background: rgba(15, 76, 92, 0.1);
    color: var(--color-deep-teal);
    font-weight: 600;
  }

  body.dark .nav-pill.active {
    border-color: var(--color-dark-teal);
    background: rgba(88, 166, 184, 0.15);
    color: var(--color-dark-teal);
  }

  /* Social Icons */
  .social-links {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .social-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border: 1px solid var(--color-warm-border);
    border-radius: 4px;
    color: var(--color-warm-text-secondary);
    transition: all 0.2s ease;
  }

  body.dark .social-link {
    border-color: var(--color-dark-border);
    color: var(--color-dark-text-secondary);
  }

  .social-link:hover {
    border-color: var(--color-deep-teal);
    color: var(--color-deep-teal);
  }

  body.dark .social-link:hover {
    border-color: var(--color-dark-teal);
    color: var(--color-dark-teal);
  }

  /* Mobile Menu Toggle */
  .menu-toggle {
    display: none;
    flex-direction: row;
    align-items: center;
    gap: 2px;
    padding: 5px 10px;
    background: transparent;
    border: 1px solid var(--color-warm-border);
    border-radius: 4px;
    cursor: pointer;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    color: var(--color-warm-text-primary);
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  body.dark .menu-toggle {
    border-color: var(--color-dark-border);
    color: var(--color-dark-text-primary);
  }

  .menu-toggle:hover {
    border-color: var(--color-deep-teal);
    color: var(--color-deep-teal);
    background: rgba(15, 76, 92, 0.05);
  }

  body.dark .menu-toggle:hover {
    border-color: var(--color-dark-teal);
    color: var(--color-dark-teal);
    background: rgba(88, 166, 184, 0.1);
  }

  .toggle-bracket {
    color: var(--color-warm-text-secondary);
  }

  body.dark .toggle-bracket {
    color: var(--color-dark-text-secondary);
  }

  /* Mobile Navigation (dropdown) */
  .mobile-nav {
    display: none;
    flex-direction: column;
    gap: 8px;
    padding: 16px 20px;
    background: rgba(248, 246, 243, 0.98);
    border-bottom: 1px solid var(--color-warm-border);
    backdrop-filter: blur(8px);
  }

  body.dark .mobile-nav {
    background: rgba(13, 17, 23, 0.98);
    border-bottom-color: var(--color-dark-border);
  }

  .mobile-nav.active {
    display: flex;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .terminal-strip {
      gap: 12px;
      padding: 8px 16px;
    }

    .terminal-nav {
      display: none;
    }

    .social-links {
      gap: 6px;
    }

    .social-link {
      width: 30px;
      height: 30px;
    }

    .menu-toggle {
      display: flex;
    }
  }

  /* Scroll Progress Bar (2px at bottom) */
  .terminal-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--color-warm-border);
    overflow: hidden;
  }

  body.dark .terminal-progress {
    background: var(--color-dark-border);
  }

  .progress-cursor {
    position: absolute;
    top: 0;
    left: 0;
    width: 16px;
    height: 100%;
    background: var(--color-deep-teal);
    animation: cursorPulse 0.8s ease-in-out infinite;
  }

  body.dark .progress-cursor {
    background: var(--color-dark-teal);
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(
      90deg,
      var(--color-deep-teal) 0%,
      rgba(15, 76, 92, 0.6) 100%
    );
    width: 0%;
    transition: width 0.1s ease-out;
  }

  body.dark .progress-bar {
    background: linear-gradient(
      90deg,
      var(--color-dark-teal) 0%,
      rgba(88, 166, 184, 0.6) 100%
    );
  }

  @keyframes cursorPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  /* Header background on scroll */
  .terminal-header.scrolled .terminal-strip {
    background: rgba(248, 246, 243, 0.98);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
  }

  body.dark .terminal-header.scrolled .terminal-strip {
    background: rgba(13, 17, 23, 0.98);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
  }

  .terminal-header.scrolled .mobile-nav {
    background: rgba(248, 246, 243, 0.98);
  }

  body.dark .terminal-header.scrolled .mobile-nav {
    background: rgba(13, 17, 23, 0.98);
  }
</style>

<script>
  // Terminal prompt click to scroll to top
  const terminalPrompt = document.getElementById('terminal-prompt');
  terminalPrompt?.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Mobile menu toggle
  const menuToggle = document.getElementById('terminal-menu-toggle');
  const mobileNav = document.getElementById('mobile-nav');

  menuToggle?.addEventListener('click', () => {
    mobileNav.classList.toggle('active');
  });

  // Close mobile menu when clicking a link
  const allNavLinks = document.querySelectorAll('.nav-pill');
  allNavLinks.forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        mobileNav.classList.remove('active');
      }
    });
  });

  // Scroll progress and header state
  let ticking = false;

  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        const scrollY = window.scrollY;
        const header = document.getElementById('terminal-header');
        const progressBar = document.querySelector('.progress-bar');
        const progressCursor = document.querySelector('.progress-cursor');

        // Update header scrolled state
        if (scrollY > 50) {
          header?.classList.add('scrolled');
        } else {
          header?.classList.remove('scrolled');
        }

        // Update scroll progress
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = (scrollY / docHeight) * 100;
        if (progressBar) {
          progressBar.style.width = `${Math.min(progress, 100)}%`;
        }
        if (progressCursor) {
          progressCursor.style.left = `${Math.min(progress, 100)}%`;
        }

        ticking = false;
      });
      ticking = true;
    }
  });

  const sections = ['about', 'projects', 'experience', 'education', 'references'];
  const navLinks = document.querySelectorAll('[data-nav]');

  const observerOptions = {
    root: null,
    rootMargin: '-50% 0px -50% 0px',
    threshold: 0,
  };

  const sectionObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        navLinks.forEach((link) => {
          if (link.getAttribute('data-nav') === id) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }
    });
  }, observerOptions);

  sections.forEach((section) => {
    const element = document.getElementById(section);
    if (element) sectionObserver.observe(element);
  });
</script>
